<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta lang="en">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ChatPUA👍🏻</title>
    <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .login-box {
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      width: 400px;
    }
    .login-box h2 {
      margin-top: 0;
      font-size: 24px;
      text-align: center;
    }

    .login-box h6 {
      margin-top: 0;
      text-align: right;
    }

    .login-box input {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-sizing: border-box;
      width: 100%;
      height: 50px;
    }

    .login-box button{
      background-color: #333;
      color: #fff;
      border: 0;
      border-radius: 20px;
      cursor: pointer;
      padding: 10px;
      width: 20%;
      height: 100%;
      float: right;
    }

    .login-box button:hover{
        transition-duration: 0.3s;
        background-color: #45a049;
    }
    .interaction{
      border: 2px solid black;
      height: 300px;
      overflow-y: scroll;
      margin-bottom: 8px;
      border-radius: 10px;
    }
    .content{
      padding-left: 10px;
    }

    .options {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    } 
    </style>
</head>
<body>
  <div class="container">
    <div class="login-box">
        <h2>ChatPUA👍🏻</h2>
        <h6 class="author">shitted by DINOREXNB</h6>
        <div class="interaction" id="interaction">       
        </div>
        <div>
          <input type="text" placeholder="let's chat!" name="text" id="query">
        </div>
        <div>
          <button type="submit" value="发送" id="submit">发送</button>
        </div>
    </div>
  </div>
  <div class="options">
    <div class="models" style="display: inline-block; margin-left: 20px;margin-right: 20px;">
      <h2 style="height: 10px;">Models</h2>
      <form>
        <input type="radio" id="model1" name="option" value="option1">
        <label for="model1"><b>gpt-4 (PLUS only)</b></label><br>
        <input type="radio" id="model2" name="option" value="option2" checked>
        <label for="model2"><b>gpt-3.5-turbo</b></label><br>
        <input type="radio" id="model3" name="option" value="option3">
        <label for="model3"><b>gpt-3.5-turbo-0613</b></label>
      </form>
    </div>
    <div class="context-linkage" style="display: inline-block;margin: auto;">
      <h2 style="margin-top: 0px;">Context Linkage</h2>
        <input type="checkbox" id="Context-linkage" name="Context-linkage" value="option2">
        <label for="Context-linkage"><b>True</b></label><br>
    </div>
    <div class="temperature" style="display: inline-block;margin-left: 20px; margin-right: 20px;" id="temperature">
        <div id="value"><h2 style="height: 45px;">Temperature:0.5</h2></div>
        <input type="range" min="0" max="9" id="temperature-range">
    </div>
  </div>
  <script>
    const btn=document.getElementById("submit");
    const interaction=document.getElementById("interaction");
    const MODEL1=document.getElementById("model1");
    const MODEL2=document.getElementById("model2");
    const MODEL3=document.getElementById("model3");
    const Contextlinkage=document.getElementById("Context-linkage")
    const Temperature=document.getElementById("temperature");
    var orgid="";
    var APIkey="";
    var query="";
    var model="gpt-3.5-turbo";
    var isContextLinkage=0;
    var temperature=0.5;
    var historical_dialogue=[];
    //选择模型
    MODEL1.addEventListener('input',()=>{
      model="gpt-4";
      console.log("model: "+model);
    })
    MODEL2.addEventListener('input',()=>{
      model="gpt-3.5-turbo";
      console.log("model: "+model);
    })
    MODEL3.addEventListener('input',()=>{
      model="gpt-3.5-turbo-0613";
      console.log("model: "+model);
    })
    //选择是否联系上下文
    Contextlinkage.addEventListener('input',()=>{
      isContextLinkage=1-isContextLinkage;
    })
    //选择逆天程度
    Temperature.addEventListener('input',()=>{
      temperature=document.getElementById("temperature-range").value;
      document.getElementById("value").innerHTML=`<h2 style="height: 50px;">Temperature:${temperature/10}</h2>`;
    })
    //获取输入的orgid与APIkey
    fetch('get-info')
    .then(response=>response.json())
    .then(data=>{
      orgid=data.orgid;
      APIkey=data.APIkey;
    })
    .catch(error=>console.log(error));
    //处理对话
    btn.addEventListener("click",()=>{
      if(document.getElementById("query").value!=''){
        console.log("已发送请求...");
        interaction.innerHTML=interaction.innerHTML+`<div class="content"><h3>You:</h3><p>${document.getElementById("query").value}</p></div>`;
        interaction.scrollTop=interaction.scrollHeight;
        query=document.getElementById("query").value;
        document.getElementById("query").value='';
        console.log("query: "+query);
        //添加用户历史对话
        historical_dialogue=historical_dialogue.concat([{"role":"user","content":query}]);
        console.log("历史对话:");
        console.dir(JSON.stringify(historical_dialogue));
        //发送请求
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.openai.com/v1/chat/completions');
        xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
            let Response=JSON.parse(xhr.responseText);
            //添加GPT历史对话
            historical_dialogue=historical_dialogue.concat([{"role":"assistant","content":Response.choices[0].message.content}]);
            //增添回复
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content">
              <h3>PUA:</h3>
              <p>${Response.choices[0].message.content}</p>
            </div>
            `;
            interaction.scrollTop=interaction.scrollHeight;
          } else {interaction.innerHTML=interaction.innerHTML+`
            <div class="content">
              <h3>PUA:</h3>
              <p>❌请求失败，状态码：${xhr.status}</p>
            </div>
            `;
            interaction.scrollTop=interaction.scrollHeight;
            console.error('请求失败，状态码：' + xhr.status + '，错误信息：' + xhr.statusText);
          }
        };
        const data = {
          "model": model,
          "messages": historical_dialogue,
          "temperature": temperature/10,
        };
        console.log(data);
        xhr.send(JSON.stringify(data));
      }
    })
  </script>
</body>
</html>