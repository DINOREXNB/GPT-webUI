<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta lang="en">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ChatPUAüëçüèª</title>
    <script src="https://cdn.bootcss.com/marked/0.8.1/marked.min.js"></script>
    <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }

    .mainbox {
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-right: 12.5%;
      margin-left: 6%;
      width: 75%;
      height: 90%;
    }
    .mainbox h2 {
      margin-top: 0;
      font-size: 24px;
      text-align: center;
    }

    .mainbox h6 {
      margin-top: 0;
      text-align: right;
    }

    .mainbox input {
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
      box-sizing: border-box;
      width: 100%;
      height: 50px;
    }

    .mainbox button{
      background-color: #333;
      color: #fff;
      border: 0;
      border-radius: 20px;
      cursor: pointer;
      padding: 10px;
      width: 80px;
      height: 100%;
      float: right;
      margin: 5px;
    }

    .mainbox button:hover{
        transition-duration: 0.3s;
        background-color: #45a049;
    }

    .back{
      background-color: #333;
      color: #fff;
      border: 0;
      border-radius: 10px;
      cursor: pointer;
      width: 40px;
      height: 30px;
      float: right;
      margin: 5px;
      float: left;
      font-size: large;
    }

    .back:hover{
      transition-duration: 0.3s;
      background-color: #45a049;
    }

    .interaction{
      border: 2px solid black;
      height: 70%;
      overflow-y: scroll;
      margin-bottom: 8px;
      border-radius: 10px;
    }

    .interaction button{
      height: 5%;
      width: 85px;
      padding-bottom: 10px;
      margin-bottom: 5px;
      height: 100%;
      float: right;
    }
    .content{
      padding-left: 10px;
    }
    .ReplyContent{
      border:1px solid black;
      border-radius: 10px;
      word-break: break-all;
      padding-left: 5px;
      padding-right: 5px;
    }
    .options {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding: 10px;
    } 
    .audiototext{
      height: 40px;
      width: 40px;
      cursor: pointer;
    }
    .texttoimage{
      height: 40px;
      width: 40px;
      cursor: pointer;
    }
    .prompt{
      height: 40px;
      width: 40px;
      cursor: pointer;
      border-radius: 50%;
    }
    </style>
</head>
<body>
  <button class="back" id="back">‚Üê</button>
  <div class="container">
    <div class="mainbox">
        <h2>ChatPUAüëçüèª</h2>
        <h6 class="author">shitted by DINOREXNB</h6>
        <div class="interaction" id="interaction">       
        </div>
        <div>
          <input type="text" placeholder="let's chat!" name="text" id="query">
        </div>
        <div>
          <img src="./images/audiototext.png" alt="" id="audiototext" class="audiototext">
          <img src="./images/texttoimage.png" alt="" id="texttoimage" class="audiototext">
          <img src="./images/prompt.png" alt="" id="prompt" class="prompt">
          <button type="submit" value="ÂèëÈÄÅ" id="submit">ÂèëÈÄÅ</button>
        </div>
    </div>
  </div>
  <div class="options">
    <div class="models" style="display: inline-block; margin-left: 20px;margin:auto">
      <h2 style="height: 10px;">Models</h2>
      <form>
        <input type="radio" id="model1" name="option" value="option1">
        <label for="model1"><b>gpt-4 (PLUS only)</b></label><br>
        <input type="radio" id="model2" name="option" value="option2" checked>
        <label for="model2"><b>gpt-3.5-turbo</b></label><br>
        <input type="radio" id="model3" name="option" value="option3">
        <label for="model3"><b>gpt-3.5-turbo-0613</b></label>
      </form>
    </div>
    <div class="context-linkage" style="display: inline-block;margin: auto;">
      <h2 style="margin-top: 0px;">Context Linkage</h2>
        <input type="checkbox" id="Context-linkage" name="Context-linkage" value="option2" checked>
        <label for="Context-linkage"><b>True</b></label><br>
    </div>
    <div class="temperature" style="display: inline-block;margin:auto" id="temperature">
        <div id="value"><h2 style="height: 45px;">Temperature:0.5</h2></div>
        <input type="range" min="0" max="9" id="temperature-range">
    </div>
  </div>
  <div class="options">
    <div class="" style="display: inline-block; margin:auto">
      <div id="numofimages"><h2 style="height: 45px;">Num of images:1</h2></div>
      <input type="range" min="1" max="10" id="images-range" value="1">
    </div>
    <div class="Image size" style="display: inline-block;margin: auto;" id="Image size">
        <div id="value"><h2 style="height: 10px;">Image size</h2></div>
       <input type="radio" id="size1" name="option" value="option1" checked>
        <label for="size1"><b>256x256</b></label><br>
        <input type="radio" id="size2" name="option" value="option2">
        <label for="size2"><b>512x512</b></label><br>
        <input type="radio" id="size3" name="option" value="option3">
        <label for="size3"><b>1024x1024</b></label>
    </div>
  </div>
  <div id="reply0"></div>
  <script> 
    const btn=document.getElementById("submit");
    const interaction=document.getElementById("interaction");
    const MODEL1=document.getElementById("model1");
    const MODEL2=document.getElementById("model2");
    const MODEL3=document.getElementById("model3");
    const Contextlinkage=document.getElementById("Context-linkage")
    const Temperature=document.getElementById("temperature");
    const prompt=document.getElementById("prompt");
    const audiototext=document.getElementById("audiototext");
    const texttoimage=document.getElementById("texttoimage");
    const SIZE1=document.getElementById("size1");
    const SIZE2=document.getElementById("size2");
    const SIZE3=document.getElementById("size3");
    const NUMofIMAGES=document.getElementById("images-range");

    var orgid="";
    var APIkey="";
    var query="";
    var model="gpt-3.5-turbo";
    var isContextLinkage=1;
    var temperature=5;
    var historical_dialogue=[];    
    var historical_reply=[];
    var historical_tocopy=[];
    var replyID=0;
    var max_dialogue_record=10;
    var size="256x256";
    var numofimages=1;
    var formaudio = new FormData();

    //ÈÄâÊã©Ê®°Âûã***********************************
    MODEL1.addEventListener('input',()=>{
      model="gpt-4";
      console.log("model: "+model);
    })
    MODEL2.addEventListener('input',()=>{
      model="gpt-3.5-turbo";
      console.log("model: "+model);
    })
    MODEL3.addEventListener('input',()=>{
      model="gpt-3.5-turbo-0613";
      console.log("model: "+model);
    })

    //ÈÄâÊã©ÂõæÂÉèÂ§ßÂ∞è***********************************
    SIZE1.addEventListener("click",()=>{
      size="256x256";
      console.log("image size:256x256");
    });
    SIZE2.addEventListener("click",()=>{
      size="512x512";
      console.log("image size:512x512");
    });
    SIZE3.addEventListener("click",()=>{
      size="1024x1024";
      console.log("image size:1024x1024");
    });

    //ÈÄâÊã©ÂõæÂÉèÊï∞Èáè***********************************
    NUMofIMAGES.addEventListener("input",()=>{
      numofimages=NUMofIMAGES.value;
      document.getElementById("numofimages").innerHTML=`<h2 style="height: 45px;">Num of images:${numofimages}</h2></h2>`;
    });

    //ÈÄâÊã©ÊòØÂê¶ËÅîÁ≥ª‰∏ä‰∏ãÊñá***********************************
    Contextlinkage.addEventListener('input',()=>{
      isContextLinkage=1-isContextLinkage;
      console.log("Context Linkage:"+isContextLinkage);
    })

    //ÈÄâÊã©ÈÄÜÂ§©Á®ãÂ∫¶***********************************
    Temperature.addEventListener('input',()=>{
      temperature=document.getElementById("temperature-range").value;
      document.getElementById("value").innerHTML=`<h2 style="height: 50px;">Temperature:${temperature/10}</h2>`;
    })

    //Ëé∑ÂèñËæìÂÖ•ÁöÑorgid‰∏éAPIkey***********************************
    fetch('get-info')
    .then(response=>response.json())
    .then(data=>{
      orgid=data.orgid;
      APIkey=data.APIkey;
    })
    .catch(error=>console.log(error));

    //Ê∑ªÂä†È¢ÑËÆæ‰∫∫Ê†º***********************************
    prompt.addEventListener('click',()=>{
      if(document.getElementById("query").value!=''){
        console.log("Â∑≤ÂèëÈÄÅËØ∑Ê±Ç...");     
        query=document.getElementById("query").value;
        document.getElementById("query").value='';
        console.log("query: "+query);
        if(replyID!=0){
          document.getElementById(`regenerate${replyID-1}`).innerHTML='';
        }
        //Ê∑ªÂä†Áî®Êà∑ÂéÜÂè≤ÂØπËØù
        historical_dialogue=historical_dialogue.concat([{"role":"user","content":query}]);
        if(historical_dialogue.length>max_dialogue_record){
          historical_dialogue.shift();
        }
        console.log("ÂéÜÂè≤ÂØπËØù:");
        console.log(JSON.stringify(historical_dialogue));
        //ÂèëÈÄÅËØ∑Ê±Ç
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.openai.com/v1/chat/completions');
        xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
            let Response=JSON.parse(xhr.responseText);
            console.log(xhr.responseText);
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content" id="replyprompt">
              <h3>PUA:</h3>
              <div class="ReplyContent">
              <p id="promptsuccess"></p>
              </div>
            </div>
            `;
            var text=`‰∫∫Ê†ºÂä†ËΩΩÊàêÂäüÔºÅ`;
            var index=0;
            var textElement = document.getElementById(`promptsuccess`);
            function showText() {
              if (index < text.length) {
                textElement.innerHTML += text.charAt(index);
                interaction.scrollTop=interaction.scrollHeight;
                index++;
                setTimeout(showText, 20); 
              }
            }
            showText();
            //Ê∑ªÂä†GPTÂéÜÂè≤ÂØπËØù
            historical_dialogue=historical_dialogue.concat([{"role":"assistant","content":Response.choices[0].message.content}]);
            if(historical_dialogue.length>max_dialogue_record){
              historical_dialogue.shift();
            }
            console.log(historical_reply);
          }else{
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content">
              <h3>PUA:</h3>
              <div class="ReplyContent">
              <p>‚ùåËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö${xhr.status}</p>
              </div>
            </div>
            `;
            console.log(historical_reply);
            console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö' + xhr.status + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + xhr.statusText);
          }
        };
        if(isContextLinkage){
          const data = {
            "model": model,
            "messages": historical_dialogue,
            "temperature": temperature/10,
          };
          console.log(data);
          xhr.send(JSON.stringify(data));
        }else{
          const data = {
            "model": model,
            "messages": [{"role":"user","content":query}],
            "temperature": temperature/10,
          };
          console.log(data);
          xhr.send(JSON.stringify(data));
        }
      }
    });
    //ËØ≠Èü≥ËΩ¨ÊñáÂ≠ó(bug)***********************************
    audiototext.addEventListener('click',()=>{
      query=document.getElementById("query").value;
      document.getElementById("query").value='';
      console.log("query: "+query);
      console.log("ÈÄâÊã©Èü≥È¢ëÊñá‰ª∂...");
      const input = document.createElement('input');
      input.type = 'file';
      input.accept="audio/*"
      // ÂΩìÁî®Êà∑ÈÄâÊã©Êñá‰ª∂Êó∂Ëß¶Âèë
      input.addEventListener('change', () => {
        // Ëé∑ÂèñÁî®Êà∑ÈÄâÊã©ÁöÑÊñá‰ª∂
        const file = input.files[0];
        const reader=new FileReader();
        if(replyID){
          document.getElementById(`regenerate${replyID-1}`).innerHTML='';
        }
        reader.addEventListener('load',()=>{
          //‰∏ä‰º†Êñá‰ª∂
          const xhr = new XMLHttpRequest();
          xhr.open('POST', 'https://api.openai.com/v1/audio/transcriptions');
          xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
          xhr.setRequestHeader('Content-Type', 'multipart/form-data');
          xhr.onload = function() {
            if (xhr.status === 200) {
              let Response=JSON.parse(xhr.responseText);
              console.log(Response);
              //Â¢ûÊ∑ªÂõûÂ§ç
              interaction.innerHTML=interaction.innerHTML+`
              <div class="content">
                <h3>PUA:</h3>
                <div class="ReplyContent">
                <p>${Response.text}</p>
                </div>
              </div>
              `;
              interaction.scrollTop=interaction.scrollHeight;
            }else{
              interaction.innerHTML=interaction.innerHTML+`
              <div class="content">
                <h3>PUA:</h3>
                <div class="ReplyContent">
                <p>‚ùåËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö${xhr.status}</p>
                </div>
              </div>
              `;
              interaction.scrollTop=interaction.scrollHeight;
              console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö' + xhr.status + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + xhr.statusText);
            }
          };
          // ÂàõÂª∫‰∏Ä‰∏™FormdataÂØπË±°ÔºåÂπ∂Â∞ÜÊñá‰ª∂Ê∑ªÂä†Âà∞ÂÖ∂‰∏≠
          formaudio.append("file", file);
          formaudio.append("model", 'whisper-1');
          formaudio.append("prompt",query);
          //ÊâìÂç∞
          console.log(file);
          formaudio.forEach((value, key) => {
            console.log(`${key}: ${value}`);
          });
          xhr.send(formaudio);
        });
        // ÂºÄÂßãËØªÂèñÊñá‰ª∂
        reader.readAsBinaryString(file);
      });
      input.click();
    });
    //ÊñáÂ≠óÁîüÊàêÂõæÁâá***********************************
    texttoimage.addEventListener('click',()=>{
      if(document.getElementById("query").value!=''){
        console.log("Â∑≤ÂèëÈÄÅËØ∑Ê±Ç...");     
        interaction.innerHTML=interaction.innerHTML+`
        <div class="content">
          <h3>You:</h3>
          <div class="ReplyContent">
          <p>${document.getElementById("query").value}</p>
          </div>
        </div>
        `;
        interaction.scrollTop=interaction.scrollHeight;
        query=document.getElementById("query").value;
        document.getElementById("query").value='';
        console.log("query: "+query);
        if(replyID){
          document.getElementById(`regenerate${replyID-1}`).innerHTML='';
        }
        //ÂèëÈÄÅËØ∑Ê±Ç
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.openai.com/v1/images/generations');
        xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
            let Response=JSON.parse(xhr.responseText);
            console.log(Response);
            //Â¢ûÊ∑ªÂõûÂ§ç
            interaction.innerHTML=interaction.innerHTML+`
              <div class="content">
                <h3>PUA:</h3>
              </div>
              `;
            for(var cnt=0;cnt<numofimages;cnt++){
              interaction.innerHTML=interaction.innerHTML+`
              <div class="content">
                <img src='${Response.data[cnt].url}' alt=''>
              </div>
              `;
              interaction.scrollTop=interaction.scrollHeight;
            }
          }else{
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content">
              <h3>PUA:</h3>
              <div class="ReplyContent">
              <p>‚ùåËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö${xhr.status}</p>
              </div>
            </div>
            `;
            interaction.scrollTop=interaction.scrollHeight;
            console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö' + xhr.status + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + xhr.statusText);
          }
        };
        const data = {
          "prompt": query,
          "n":parseInt(numofimages),
          "size":size,
        };
        console.log(data);
        xhr.send(JSON.stringify(data));
      }
    });
    //ÈáçÊñ∞ÁîüÊàêÂõûÂ§ç***********************************
    function resendrequest(){      
      console.log("Regenerating...");
      historical_dialogue.pop();
      if(replyID){
       document.getElementById(`reply${replyID-1}`).innerHTML='';
      }
      console.log("Â∑≤ÂèëÈÄÅËØ∑Ê±Ç...");
      console.log("query: "+query);
      console.log("ÂéÜÂè≤ÂØπËØù:");
      console.log(JSON.stringify(historical_dialogue));
      //ÂèëÈÄÅËØ∑Ê±Ç
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'https://api.openai.com/v1/chat/completions');
      xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.onload = function() {
        if (xhr.status === 200) {
          let Response=JSON.parse(xhr.responseText);
          console.log(Response);
          //Ê∑ªÂä†GPTÂéÜÂè≤ÂØπËØù
          historical_dialogue=historical_dialogue.concat([{"role":"assistant","content":Response.choices[0].message.content}]);
          if(historical_dialogue.length>max_dialogue_record){
            historical_dialogue.shift();
          }
          //Â¢ûÊ∑ªÂõûÂ§ç
          var htmltext=marked(Response.choices[0].message.content);
          interaction.innerHTML=interaction.innerHTML+`
          <div class="content" id="reply${replyID}">
            <h3>PUA:</h3>
            <div class="ReplyContent" id="ReplyContent${replyID}">
            
            </div>
            <button id="${replyID}" onclick="copyContent(this.id)">Copy</button>
            <div id="regenerate${replyID}">
              <button id="regeneratebtn${replyID}">Regenerate</button>
            </div>
          </div>
          `;
          var index = 0;
          var temp='';
          var textElement = document.getElementById(`ReplyContent${replyID}`);
          function showText() {
             if (index < htmltext.length) {
              temp+=htmltext.charAt(index);
              if(htmltext.charAt(index)!='<'&&htmltext.charAt!='>'&&htmltext.charAt(index)!='/'){
                textElement.innerHTML=`${temp}`;
              }
              interaction.scrollTop=interaction.scrollHeight;
              index++;
              setTimeout(showText, 20);
            }
          }
          showText();
          historical_reply.push(document.getElementById(`regeneratebtn${replyID}`));
          historical_reply[replyID].addEventListener('click',resendrequest);
          replyID++;
          console.log(historical_reply);
        }else{
          var text=`‚ùåËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö${xhr.status}`
          interaction.innerHTML=interaction.innerHTML+`
          <div class="content" id=reply${replyID}>
            <h3>PUA:</h3>
            <div class="ReplyContent" id="ReplyContent${replyID}">
            <p id='texterror${replyID}'></p>
            </div>
            <div id="regenerate${replyID}">
              <button id="regeneratebtn${replyID}">Regenerate</button>
            </div>
          </div>
          `;
          var index = 0;
          var textElement = document.getElementById(`texterror${replyID}`);
          function showText() {
            if (index < text.length) {
              textElement.innerHTML += text.charAt(index);
              interaction.scrollTop=interaction.scrollHeight;
              index++;
              setTimeout(showText, 20); 
            }
          }
          showText();
          historical_reply.push(document.getElementById(`regeneratebtn${replyID}`));
          historical_reply[replyID].addEventListener('click',resendrequest);
          replyID++;
          console.log(historical_reply);
          console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö' + xhr.status + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + xhr.statusText);
       }
       };
       if(isContextLinkage){
         const data = {
           "model": model,
           "messages": historical_dialogue,
           "temperature": temperature/10,
         };
         console.log(data);
         xhr.send(JSON.stringify(data));
        }else{
          const data = {
            "model": model,
            "messages": [{"role":"user","content":query}],
            "temperature": temperature/10,
          };
          console.log(data);
          xhr.send(JSON.stringify(data));
        }
    }
    //ÁîüÊàêÂõûÂ§ç***********************************
    function sendrequest(){
      if(document.getElementById("query").value!=''){
        console.log("Â∑≤ÂèëÈÄÅËØ∑Ê±Ç...");     
        interaction.innerHTML=interaction.innerHTML+`
        <div class="content">
          <h3>You:</h3>
          <div class="ReplyContent">
          <p>${document.getElementById("query").value}</p>
          </div>
        </div>
        `;
        interaction.scrollTop=interaction.scrollHeight;
        query=document.getElementById("query").value;
        document.getElementById("query").value='';
        console.log("query: "+query);
        if(replyID!=0){
          var errortext="";
          try{
            document.getElementById(`regenerate${replyID-1}`).innerHTML='';
          }catch(error){
            errortext=error
            console.log(errortext);
          }
          if(errortext==""){
            document.getElementById(`regenerate${replyID-1}`).innerHTML='';
          }
        }
        //Ê∑ªÂä†Áî®Êà∑ÂéÜÂè≤ÂØπËØù
        historical_dialogue=historical_dialogue.concat([{"role":"user","content":query}]);
        if(historical_dialogue.length>max_dialogue_record){
          historical_dialogue.shift();
        }
        console.log("ÂéÜÂè≤ÂØπËØù:");
        console.log(JSON.stringify(historical_dialogue));
        //ÂèëÈÄÅËØ∑Ê±Ç
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'https://api.openai.com/v1/chat/completions');
        xhr.setRequestHeader('Authorization', 'Bearer '+APIkey);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function() {
          if (xhr.status === 200) {
            let Response=JSON.parse(xhr.responseText);
            console.log(Response);
            //Ê∑ªÂä†GPTÂéÜÂè≤ÂØπËØù
            historical_dialogue=historical_dialogue.concat([{"role":"assistant","content":Response.choices[0].message.content}]);
            if(historical_dialogue.length>max_dialogue_record){
              historical_dialogue.shift();
            }
            //Â¢ûÊ∑ªÂõûÂ§ç
            var htmltext=marked(Response.choices[0].message.content);
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content" id="reply${replyID}">
              <h3>PUA:</h3>
              <div class="ReplyContent" id="ReplyContent${replyID}">
              
              </div>
              <button id="${replyID}" onclick="copyContent(this.id)">Copy</button>
              <div id="regenerate${replyID}">
                <button id="regeneratebtn${replyID}">Regenerate</button>
              </div>
            </div>
            `;
            var index = 0;
            var temp='';
            var textElement = document.getElementById(`ReplyContent${replyID}`);
            function showText() {
              if (index < htmltext.length) {
                temp+=htmltext.charAt(index);
                if(htmltext.charAt(index)!='<'&&htmltext.charAt!='>'&&htmltext.charAt(index)!='/'){
                  textElement.innerHTML=`${temp}`;
                }
                interaction.scrollTop=interaction.scrollHeight;
                index++;
                setTimeout(showText, 20);
              }
            }
            showText();
            historical_reply.push(document.getElementById(`regeneratebtn${replyID}`));
            historical_reply[replyID].addEventListener('click',resendrequest);
            replyID++;
            console.log(historical_reply);
          }else{
            var text=`‚ùåËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö${xhr.status}`
            interaction.innerHTML=interaction.innerHTML+`
            <div class="content" id=reply${replyID}>
              <h3>PUA:</h3>
              <div class="ReplyContent" id="ReplyContent${replyID}">
              <p id='texterror${replyID}'></p>
              </div>
              <div id="regenerate${replyID}">
                <button id="regeneratebtn${replyID}">Regenerate</button>
              </div>
            </div>
            `;
            var index = 0;
            var textElement = document.getElementById(`texterror${replyID}`);
            function showText() {
              if (index < text.length) {
                textElement.innerHTML += text.charAt(index);
                interaction.scrollTop=interaction.scrollHeight;
                index++;
                setTimeout(showText, 20); 
              }
            }
            showText();
            historical_reply.push(document.getElementById(`regeneratebtn${replyID}`));
            historical_reply[replyID].addEventListener('click',resendrequest);
            replyID++;
            console.log(historical_reply);
            console.error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†ÅÔºö' + xhr.status + 'ÔºåÈîôËØØ‰ø°ÊÅØÔºö' + xhr.statusText);
          }
        };
        if(isContextLinkage){
          const data = {
            "model": model,
            "messages": historical_dialogue,
            "temperature": temperature/10,
          };
          console.log(data);
          xhr.send(JSON.stringify(data));
        }else{
          const data = {
            "model": model,
            "messages": [{"role":"user","content":query}],
            "temperature": temperature/10,
          };
          console.log(data);
          xhr.send(JSON.stringify(data));
        }
      }
    }
    //‰ΩøÁî®ÂõûËΩ¶ÂèëÈÄÅÂÜÖÂÆπÁîüÊàêÂõûÂ§ç***********************************
    function sendrequestKey(){
      if(event.code=='Enter'){
        sendrequest();
      }
    }
    btn.addEventListener("click",sendrequest);
    //ÂõûËΩ¶ÂèëÈÄÅÂÜÖÂÆπ***********************************
    document.addEventListener("keydown",sendrequestKey);
    //Â§çÂà∂ÂØπËØùÂÜÖÂÆπ***********************************
    function copyContent(id){
      var content_text=document.getElementById(`ReplyContent${id}`).innerText;
      var textarea=document.createElement("textarea");
      textarea.value=content_text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
    document.getElementById('back').addEventListener('click',()=>{
      alert('ËøîÂõûÁôªÂΩïÁïåÈù¢');
      window.location.href="/"
    });
  </script>
</body>
</html>